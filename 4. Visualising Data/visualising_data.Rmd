---
title: "Visualising Data"
author: "Adnan Shroufi"
date: "2025-02-11"
output: html_document
---

```{r setup, echo=TRUE, eval=TRUE}
if (!requireNamespace("rprojroot", quietly = TRUE)) {install.packages("rprojroot")}
knitr::opts_knit$set(root.dir = rprojroot::find_root(criterion = rprojroot::is_rstudio_project))
```

# Introduction

Visualising is an important tool in both analytics and data science.
Visualising data can help us better understand data and see trends in data, amongst other things.
We will use an R package called *ggplot* to do this.
We will first install this package using *install.packages*.
We will also another package called *scales* which we need to modify our charts later down the line.

```{r}
install.packages("ggplot2")
install.packages("scales")
```

We will then install this and thee dplyr packages into this session using the *library* function.

```{r}
library(ggplot2)
library(dplyr)
library(scales)
```

## Overview

Here is how R describes the ggplot2 package: 

"*ggplot2 is based on the grammar of graphics, the idea that you can build every graph from the same components: a data set, a coordinate system, and geoms—visual marks that represent data points*"

In programming terms, this means we can create a huge number of charts using ggplot2 just using 3 things:

- Dataset
- Chart Type
- Chart Aesthetic (or how variables in your data are mapped to the chart visual properties.

Below is a ggplot2 cheatsheet, that shows the range of charts that can be created using the package. 

```{r}
browseURL("https://rstudio.github.io/cheatsheets/data-visualization.pdf")
```

## Chart Types

In this session we will look at 2 kinds of chart types:

- Bar charts
- Line charts

The aesthetic for each of these chart types is just defining what information you want displayed on the chart x-axis and y-axis.

## Chart Elements

When visualising data in R (or any other programming language), there are usually a few steps you would through.

1. Aggregate the data
2. Create a basic plot
3. Refine or develop the plot

Point 1. is very important.
If you want to visualise data in a certain way, you must first aggregate the data in a certain way.
The best way to demonstrate this is through an example.

# EXample 1: Aggregate Data

Let's say I want to create a bar chart that shows the cost of Fluoxetine hydrochloride prescribing nationally each year.
Because there are only 4 years, I would need a dataframe with only 4 rows to do this, with an ITEM value per YEAR. 
To generate this data, I would have to do the following aggregation:

1. Filter the DRUG to Fluoxetine hydrochloride
2. Group by YEAR
3. Summarise and sum by ITEMS
4. Ungroup

The code would look like this:

```{r}
df_bar = data %>% 
  filter(DRUG == "Fluoxetine hydrochloride") %>% 
  group_by(YEAR) %>% 
  summarise(COST = sum(COST)) %>% 
  ungroup()
```

## Example 1: Basic Chart

Using this data, I can then define 2 of the 3 things I need to create a ggplot chart:

1. The data
2. The Chart aesthetic

I want to use the df_bar object, and I want to create a bar chart where the x-axis is the region name, and the y-axis is the total number of items.
The following code would do this.

```{r}
ggplot(df_bar, aes(YEAR, COST))
```

There are no bars, because I haven't specified my chart type.
This requires a new line of code.
Ggplot code is chained together using a *+* symbol, and not the *%>%* operator.
We will run the same code except adding *+ geom_col()* to the code (on a new line).

```{r}
ggplot(df_bar, aes(YEAR, COST)) +
  geom_col()
```

# Example 1: Refine Chart

This is a start, although the chart needs some work, the following steps would make it look nicer.

1. Change the numerical values on the y-axis to non-standard form
2. Add some axis labels and a title
3. Add some colour to the bars
4. Cahnge the background (optional and personal preference).

We will do these refinements one by one.

First, we can use the the ggplot2 package function *scale_y_continuous* and the scales package function *label_comma*.
All this does is specify a numerical value with thousand separators for a continuous variable.
As the COST is the y-axis of this chart we need *scale_y_continuous*.
If COST was the x-axis we would have to use *scale_x_continuous*.

```{r}
ggplot(df_bar, aes(YEAR, COST)) +
  geom_col()+
  scale_y_continuous(labels = label_comma())
```

Second, we can add some labels using the *labs* function, which has an *x*, *y* and *title* parameter.

```{r}
ggplot(df_bar, aes(YEAR, COST)) +
  geom_col()+
  scale_y_continuous(labels = label_comma())+
  labs(
    x = "Year",
    y = "Total prescribing cost (£)",
    title = "The total annual cost of fluoxetine hydrochloride prescribing"
  )
```

Third, we can add some colour to the bars.
We use *fill* to fill the colour inside each bar.

```{r}
ggplot(df_bar, aes(YEAR, COST)) +
  geom_col(fill = "darkblue")+
  scale_y_continuous(labels = label_comma())+
  labs(
    x = "Year",
    y = "Total prescribing cost (£)",
    title = "The total annual cost of fluoxetine hydrochloride prescribing"
  )
```

Fourthly, we can change the background by adding a theme.
AA theme just changes the overall 'look' of a chart.
Here are some of the default themes:

- theme_gray()	Default with gray background and grid lines
- theme_bw()	Black and white theme with white background
- theme_linedraw()	Minimalistic with solid black lines and white background
- theme_light()	Light theme with subtle grid lines
- theme_minimal()	Clean theme with minimal grid lines
- theme_classic()	Classic look with axis lines and ticks
- theme_void()	Completely blank canvas, no background or axes
- theme_dark()	Dark background with light grid lines
- theme_test()	Simplified version of theme_gray()

We will use the *theme_classic* option.

```{r}
ggplot(df_bar, aes(YEAR, COST)) +
  geom_col(fill = "darkblue")+
  scale_y_continuous(labels = label_comma())+
  labs(
    x = "Year",
    y = "Total prescribing cost (£)",
    title = "The total annual cost of fluoxetine hydrochloride prescribing"
  )+
  theme_classic()
```

## Example 1: Save Chart

This chart now looks okay, so we can save it if we want.
We can save a ggplot chart as a jpeg using *ggsave*.
We need to specify 3 things:

```{r}
getwd()
```

1. What folder to save the chart in, plus a name for the chart
2. The name of the actual R object
3. Define the chart output type (jpeg, pdf, etc)

Fist, we need to assign the output from this code to an object.
We will do this and just it *plot_one*.

```{r}
plot_one = ggplot(df_bar, aes(YEAR, COST)) +
  geom_col(fill = "darkblue")+
  scale_y_continuous(labels = label_comma())+
  labs(
    x = "Year",
    y = "Total prescribing cost (£)",
    title = "The total annual cost of fluoxetine hydrochloride prescribing"
  )+
  theme_classic()
```

We will now save this object in the output folder.

```{r}
ggsave("Output/example_chart_one.jpeg", plot = plot_one, device = "jpeg")
```

We now look at few more examples, to get a better idae of how to construct charts in ggplot2.

## Example 2: Aggregate the Data

Let's say I want to create a bar chart that shows how much Setraline Hydrochloride was prescribed in each region in 2024.
Because there are only 7 regions, I would need a dataframe with only 7 rows to do this, with an ITEM value per REGION. 
To generate this data, I would have to do the following aggregation:

1. Filter the DRUG to Setraline Hydrochloride
2. Filter the YEAR to 2024
3. Group by REGION
4. Summarise and sum by ITEMS
5. Ungroup

The code would look like this:

```{r}
df_bar_two = data %>% 
  filter(DRUG == "Sertraline hydrochloride", YEAR == 2024) %>% 
  group_by(REGION) %>% 
  summarise(ITEMS = sum(ITEMS)) %>% 
  ungroup() %>% 
  arrange(ITEMS)
```

## Create a Basic Chart

Once again, I need 3 things to create my basic chart:

1. The data (df_bar_two)
2. The Chart aesthetic (REGION, ITEMS)
3. The chart type (+ geom_col())

I want to use the df_bar_two object, and I want to create a bar chart where the x-axis is the region name, and the y-axis is the total number of items.
The following code would do this.

```{r}
ggplot(df_bar_two, aes(REGION, ITEMS)) +
  geom_col()
```

## Refine this Chart

This is a start, although the chart needs some work, the following steps would make it look nicer.

1. Change the numerical values on the y-axis to non-standard form
2. Arrange the values displayed in the bars in either ascending or descending order
3. Add labels and a title
4. Change the orientation of the bars
5. Change the bar fill colour and chart theme

These will be done one at a time, first converting the numerical values of the y-axis to non-standard form. 

```{r}
ggplot(df_bar_two, aes(REGION, ITEMS)) +
  geom_col() +
  scale_y_continuous(labels = label_comma())
```

Second, we need to *reorder* the names of the regions, so the item counts are in numerical order.
Currently, the region names on the x-axis are ordered alphabetically.
We can use *reorder(REGION, ITEMS)* to reorder the REGION names by ITEM count instead.
This may seem a little confusing, but is fine once you have done it a few times.

```{r}
ggplot(df_bar_two, aes(reorder(REGION, ITEMS), ITEMS)) +
  geom_col() +
  scale_y_continuous(labels = label_comma())
```

Now we can add some x and y-axis labels and a title.

```{r}
ggplot(df_bar_two, aes(reorder(REGION, ITEMS), ITEMS)) +
  geom_col() +
  scale_y_continuous(labels = label_comma()) +
  labs(
    x = "Region name",
    y = "Total number of items",
    title = "The number of sertraline hydrochloride items prescribed per region in 2024"
  )
```

Next, we can use the ggplot2 function *coord_flip* to 'flip' the axes.
This is helpful is you have very long category names, such as regions, or drug names (which can be very long).

```{r}
ggplot(df_bar_two, aes(reorder(REGION, ITEMS), ITEMS)) +
  geom_col() +
  scale_y_continuous(labels = label_comma()) +
  labs(
    x = "Region name",
    y = "Total number of items",
    title = "The number of sertraline hydrochloride items prescribed per region in 2024"
  ) +
  coord_flip()
```

And finally, we can colour the bars and add a theme.

```{r}
ggplot(df_bar_two, aes(reorder(REGION, ITEMS), ITEMS)) +
  geom_col(fill = "darkblue") +
  scale_y_continuous(labels = label_comma()) +
  labs(
    x = "Region name",
    y = "Total number of items",
    title = "The number of sertraline hydrochloride items prescribed per region in 2024"
  ) +
  coord_flip()+
  theme_classic()
```

We can then assign the ouptut from this completed chart into an object.

```{r}
plot_two = ggplot(df_bar_two, aes(reorder(REGION, ITEMS), ITEMS)) +
  geom_col(fill = "darkblue") +
  scale_y_continuous(labels = label_comma()) +
  labs(
    x = "Region name",
    y = "Total number of items",
    title = "The number of sertraline hydrochloride items prescribed per region in 2024"
  ) +
  coord_flip()+
  theme_classic()
```

And then once again save this as a jpeg.
Not forgetting to specify *both* the folder location and file name.

```{r}
ggsave("Output/example_chart_two.jpeg", plot = plot_two, device = "jpeg")
```


























- coord_flip()
- reorder()









